name: Backup Sync (6-hour)

on:
  schedule:
    # Every 6 hours: midnight, 6am, noon, 6pm UTC
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      sync_db:
        description: "Sync database"
        type: boolean
        default: true
      sync_apps:
        description: "Sync app deployments"
        type: boolean
        default: true

env:
  RESOURCE_GROUP: rg-visualstudio-lab-mana
  MYSQL_HOST: restrovision-mysql.mysql.database.azure.com
  MYSQL_USER: restrovision_admin
  MYSQL_PASS: Homeal2026Db
  PROD_DB: homeal_db
  BACKUP_DB: homeal_db_backup

jobs:
  sync-database:
    name: Sync Production DB â†’ Backup DB
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || github.event.inputs.sync_db == 'true' }}

    steps:
      - name: Install MySQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Add GitHub runner IP to MySQL firewall
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $RUNNER_IP"
          az mysql flexible-server firewall-rule create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name restrovision-mysql \
            --rule-name github-actions-runner \
            --start-ip-address $RUNNER_IP \
            --end-ip-address $RUNNER_IP 2>/dev/null || \
          az mysql flexible-server firewall-rule update \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name restrovision-mysql \
            --rule-name github-actions-runner \
            --start-ip-address $RUNNER_IP \
            --end-ip-address $RUNNER_IP 2>/dev/null || true
          echo "Waiting 15s for firewall rule to propagate..."
          sleep 15

      - name: Test MySQL connection
        env:
          MYSQL_PWD: ${{ env.MYSQL_PASS }}
        run: |
          echo "=== Connection Test ==="
          echo "Host: ${{ env.MYSQL_HOST }}"
          echo "User: ${{ env.MYSQL_USER }}"
          echo "Password length: $(echo -n '${{ env.MYSQL_PASS }}' | wc -c) chars"

          # Retry connection up to 3 times with 10s wait
          for i in 1 2 3; do
            echo "Attempt $i/3..."
            if mysql \
              --host=${{ env.MYSQL_HOST }} \
              --user=${{ env.MYSQL_USER }} \
              --ssl-mode=REQUIRED \
              --connect-timeout=10 \
              -e "SELECT 'Connection OK' AS status; SHOW DATABASES;" 2>&1; then
              echo "Connection successful on attempt $i"
              exit 0
            else
              echo "Attempt $i failed, waiting 10s..."
              sleep 10
            fi
          done
          echo "ERROR: All 3 connection attempts failed"
          exit 1

      - name: Dump production database
        env:
          MYSQL_PWD: ${{ env.MYSQL_PASS }}
        run: |
          echo "Starting mysqldump of ${{ env.PROD_DB }}..."
          mysqldump \
            --host=${{ env.MYSQL_HOST }} \
            --user=${{ env.MYSQL_USER }} \
            --ssl-mode=REQUIRED \
            --single-transaction \
            --routines \
            --triggers \
            --set-gtid-purged=OFF \
            ${{ env.PROD_DB }} > prod_dump.sql
          echo "Dump size: $(du -h prod_dump.sql | cut -f1)"
          echo "Dump completed at $(date -u)"

      - name: Restore to backup database
        env:
          MYSQL_PWD: ${{ env.MYSQL_PASS }}
        run: |
          echo "Restoring to ${{ env.BACKUP_DB }}..."
          mysql \
            --host=${{ env.MYSQL_HOST }} \
            --user=${{ env.MYSQL_USER }} \
            --ssl-mode=REQUIRED \
            ${{ env.BACKUP_DB }} < prod_dump.sql
          echo "Database sync completed at $(date -u)"

      - name: Verify backup
        env:
          MYSQL_PWD: ${{ env.MYSQL_PASS }}
        run: |
          PROD_TABLES=$(mysql --host=${{ env.MYSQL_HOST }} --user=${{ env.MYSQL_USER }} --ssl-mode=REQUIRED -N -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='${{ env.PROD_DB }}'")
          BACKUP_TABLES=$(mysql --host=${{ env.MYSQL_HOST }} --user=${{ env.MYSQL_USER }} --ssl-mode=REQUIRED -N -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='${{ env.BACKUP_DB }}'")
          echo "Production tables: $PROD_TABLES"
          echo "Backup tables: $BACKUP_TABLES"
          if [ "$PROD_TABLES" != "$BACKUP_TABLES" ]; then
            echo "WARNING: Table count mismatch!"
            exit 1
          fi
          echo "Backup verified successfully"

      - name: Remove GitHub runner IP from MySQL firewall
        if: always()
        run: |
          az mysql flexible-server firewall-rule delete \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name restrovision-mysql \
            --rule-name github-actions-runner \
            --yes 2>/dev/null || true

  sync-apps:
    name: Sync App Deployments to Backup
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || github.event.inputs.sync_apps == 'true' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build all apps
        run: |
          echo "::group::Build API"
          npm run build:api
          echo "::endgroup::"
          echo "::group::Build Admin"
          npm run build:admin
          echo "::endgroup::"
          echo "::group::Build Super Admin"
          npm run build:super-admin
          echo "::endgroup::"
        env:
          NEXT_PUBLIC_API_URL: https://api.homeal.uk
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}

      - name: Prepare API deployment
        run: |
          mkdir -p deploy-api/node_modules
          cp -r packages/api/dist deploy-api/
          cp -rL node_modules/. deploy-api/node_modules/
          cat > deploy-api/server.js << 'ENTRY'
          require('./dist/server.js');
          ENTRY
          cat > deploy-api/package.json << 'PKG'
          {
            "name": "homeal-api-deploy",
            "version": "1.0.0",
            "main": "server.js",
            "scripts": { "start": "node server.js" }
          }
          PKG
          echo "API deploy size: $(du -sh deploy-api | cut -f1)"

      - name: Prepare Admin deployment
        run: |
          mkdir -p deploy-admin
          cp -r apps/admin-web/.next/standalone/node_modules deploy-admin/
          cp apps/admin-web/.next/standalone/package.json deploy-admin/
          cp apps/admin-web/.next/standalone/apps/admin-web/server.js deploy-admin/
          cp -r apps/admin-web/.next/standalone/apps/admin-web/.next deploy-admin/.next
          cp -r apps/admin-web/.next/static deploy-admin/.next/static
          cp -r apps/admin-web/public deploy-admin/public 2>/dev/null || true
          echo "Admin deploy size: $(du -sh deploy-admin | cut -f1)"

      - name: Prepare Super Admin deployment
        run: |
          mkdir -p deploy-super-admin
          cp -r apps/super-admin/.next/standalone/node_modules deploy-super-admin/
          cp apps/super-admin/.next/standalone/package.json deploy-super-admin/
          cp apps/super-admin/.next/standalone/apps/super-admin/server.js deploy-super-admin/
          cp -r apps/super-admin/.next/standalone/apps/super-admin/.next deploy-super-admin/.next
          cp -r apps/super-admin/.next/static deploy-super-admin/.next/static
          cp -r apps/super-admin/public deploy-super-admin/public 2>/dev/null || true
          echo "Super Admin deploy size: $(du -sh deploy-super-admin | cut -f1)"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure backup apps (disable build-on-deploy)
        run: |
          for APP in homeal-api-backup homeal-admin-backup homeal-superadmin-backup; do
            echo "Configuring $APP..."
            az webapp config appsettings set --name $APP \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --settings SCM_DO_BUILD_DURING_DEPLOYMENT=false \
              --output none
            az webapp config set --name $APP \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --startup-file "node server.js" \
              --output none
            echo "  Done: $APP"
          done

      - name: Create deployment zips
        run: |
          cd deploy-api && zip -qr ../api-backup.zip . && cd ..
          echo "API zip: $(du -h api-backup.zip | cut -f1)"
          cd deploy-admin && zip -qr ../admin-backup.zip . && cd ..
          echo "Admin zip: $(du -h admin-backup.zip | cut -f1)"
          cd deploy-super-admin && zip -qr ../superadmin-backup.zip . && cd ..
          echo "Super Admin zip: $(du -h superadmin-backup.zip | cut -f1)"

      - name: Deploy backup apps via Kudu API (async)
        run: |
          TOKEN=$(az account get-access-token --query accessToken -o tsv)

          deploy_app() {
            local APP=$1
            local ZIP=$2
            echo "=== Deploying $ZIP to $APP ==="
            echo "  Zip size: $(du -h "$ZIP" | cut -f1)"
            START=$(date +%s)

            HTTP_CODE=$(curl -s -o /tmp/deploy-response.txt -w "%{http_code}" \
              -X POST "https://${APP}.scm.azurewebsites.net/api/zipdeploy?isAsync=true" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/zip" \
              --data-binary @"$ZIP" \
              --max-time 600)

            END=$(date +%s)

            if [ "$HTTP_CODE" = "202" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "  $APP: deployed (HTTP $HTTP_CODE) in $((END-START))s"
            else
              echo "  ERROR: $APP failed (HTTP $HTTP_CODE) in $((END-START))s"
              cat /tmp/deploy-response.txt 2>/dev/null
              echo ""
              return 1
            fi
          }

          deploy_app "homeal-api-backup" "api-backup.zip"
          deploy_app "homeal-admin-backup" "admin-backup.zip"
          deploy_app "homeal-superadmin-backup" "superadmin-backup.zip"

          echo ""
          echo "All backup apps synced at $(date -u)"

      - name: Ensure backup apps are stopped
        if: always()
        run: |
          for APP in homeal-api-backup homeal-admin-backup homeal-superadmin-backup; do
            az webapp stop --name $APP --resource-group ${{ env.RESOURCE_GROUP }} --output none 2>/dev/null || true
          done
          echo "Backup apps confirmed stopped"
