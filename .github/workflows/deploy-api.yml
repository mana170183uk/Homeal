name: Deploy Homeal API to Azure

on:
  push:
    branches: [main]
    paths:
      - "packages/api/**"
      - "packages/db/**"
      - "packages/shared/**"
      - "package.json"
      - "package-lock.json"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate --schema=packages/db/prisma/schema.prisma

      - name: Push DB schema
        continue-on-error: true
        run: npx prisma db push --schema=packages/db/prisma/schema.prisma --accept-data-loss
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build API
        run: npm run build:api

      - name: Prepare deployment package
        run: |
          mkdir -p deploy/packages-db/prisma deploy/packages-shared

          # API build output
          cp -r packages/api/dist deploy/

          # Workspace packages (built + metadata)
          cp -r packages/db/dist deploy/packages-db/
          cp packages/db/package.json deploy/packages-db/
          cp packages/db/prisma/schema.prisma deploy/packages-db/prisma/
          cp -r packages/shared/dist deploy/packages-shared/
          cp packages/shared/package.json deploy/packages-shared/

          # Entry point (flattened â€” Azure runs "node server.js")
          printf "require('./dist/server.js');\n" > deploy/server.js

          # package.json with runtime deps + file: refs for workspace packages
          cat > deploy/package.json << 'PKG'
          {
            "name": "homeal-api-deploy",
            "version": "1.0.0",
            "main": "server.js",
            "scripts": {
              "start": "node server.js",
              "postinstall": "npx prisma generate --schema=packages-db/prisma/schema.prisma"
            },
            "dependencies": {
              "@homeal/db": "file:./packages-db",
              "@homeal/shared": "file:./packages-shared",
              "@azure/storage-blob": "^12.25.0",
              "@prisma/client": "^6.3.0",
              "cors": "^2.8.5",
              "express": "^4.21.0",
              "express-rate-limit": "^7.5.0",
              "firebase-admin": "^13.0.0",
              "helmet": "^8.0.0",
              "ioredis": "^5.4.0",
              "jsonwebtoken": "^9.0.2",
              "multer": "^1.4.5-lts.1",
              "prisma": "^6.3.0",
              "sharp": "^0.33.0",
              "socket.io": "^4.8.0",
              "stripe": "^17.0.0",
              "zod": "^3.24.0"
            },
            "engines": {
              "node": ">=20.0.0"
            }
          }
          PKG

          # Install production deps in deploy dir (Linux CI = Linux Azure)
          cd deploy
          npm install --production
          echo "node_modules: $(ls node_modules/ | wc -l) packages"

          # Verify critical modules
          for mod in express cors helmet firebase-admin @prisma/client; do
            if [ ! -d "node_modules/$mod" ]; then
              echo "::error::Missing $mod"
              exit 1
            fi
          done

          # Verify Prisma client
          if [ ! -f "node_modules/.prisma/client/index.js" ]; then
            echo "Prisma client missing, generating..."
            npx prisma generate --schema=packages-db/prisma/schema.prisma
          fi
          echo "All modules verified"
          cd ..

          # Create zip
          cd deploy && zip -r -q ../deploy.zip . && cd ..
          ls -lh deploy.zip

      - name: Validate artifact
        run: |
          ZIP_SIZE=$(stat -c%s deploy.zip)
          echo "Zip: $ZIP_SIZE bytes"
          [ "$ZIP_SIZE" -gt 1000000 ] || { echo "::error::Zip too small"; exit 1; }
          for f in "dist/server.js" "package.json" "server.js" "node_modules/express/package.json"; do
            unzip -l deploy.zip | grep -q "$f" || { echo "::error::Missing $f"; exit 1; }
          done
          echo "Artifact OK"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Azure runtime
        run: |
          az webapp config set --name homeal-api --resource-group rg-visualstudio-lab-mana \
            --linux-fx-version "NODE|20-lts" \
            --startup-file "node server.js"

          az webapp config appsettings set --name homeal-api --resource-group rg-visualstudio-lab-mana \
            --settings SCM_DO_BUILD_DURING_DEPLOYMENT=false ENABLE_ORYX_BUILD=false

          # Remove any Docker/container settings left over
          az webapp config appsettings delete --name homeal-api --resource-group rg-visualstudio-lab-mana \
            --setting-names DOCKER_REGISTRY_SERVER_URL DOCKER_REGISTRY_SERVER_USERNAME DOCKER_REGISTRY_SERVER_PASSWORD \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE WEBSITE_RUN_FROM_PACKAGE ORYX_NODE_MODULES_COMPRESSION 2>/dev/null || true

      - name: Deploy to Azure Web App
        run: |
          az webapp deploy --name homeal-api \
            --resource-group rg-visualstudio-lab-mana \
            --src-path deploy.zip \
            --type zip \
            --async false

      - name: Restart app
        run: |
          az webapp restart --name homeal-api --resource-group rg-visualstudio-lab-mana
          echo "Waiting 30s for startup..."
          sleep 30

      - name: Health check
        run: |
          for i in $(seq 1 20); do
            code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://api.homeal.uk/health || true)
            echo "Attempt $i/20: $code"
            if [ "$code" = "200" ]; then
              echo "Health check PASSED"
              curl -s https://api.homeal.uk/health
              exit 0
            fi
            sleep 10
          done
          echo "::error::Health check failed after 200s"
          exit 1
