name: Deploy Homeal API to Azure

on:
  push:
    branches: [main]
    paths: ["packages/api/**", "packages/db/**", "packages/shared/**"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate --schema=packages/db/prisma/schema.prisma

      - name: Push DB schema & seed test users
        continue-on-error: true
        run: |
          npx prisma db push --schema=packages/db/prisma/schema.prisma --accept-data-loss
          npx tsx packages/db/prisma/seed.ts || echo "Seed skipped (users may already exist)"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build all packages
        run: npm run build:api

      - name: Prepare deployment package
        run: |
          mkdir -p deploy/packages-db/prisma deploy/packages-shared

          # 1. API build output
          cp -r packages/api/dist deploy/

          # 2. Workspace packages (built + metadata)
          cp -r packages/db/dist deploy/packages-db/
          cp packages/db/package.json deploy/packages-db/
          cp -r packages/db/prisma/schema.prisma deploy/packages-db/prisma/
          cp -r packages/shared/dist deploy/packages-shared/
          cp packages/shared/package.json deploy/packages-shared/

          # 3. Entry point
          cat > deploy/server.js << 'EOF'
          require('./dist/server.js');
          EOF

          # 4. Standalone package.json with all runtime deps + file: refs for workspace pkgs
          #    Oryx will run `npm install` on Azure to resolve these
          cat > deploy/package.json << 'EOF'
          {
            "name": "homeal-api-deploy",
            "version": "1.0.0",
            "main": "server.js",
            "scripts": {
              "start": "node server.js",
              "postinstall": "npx prisma generate --schema=packages-db/prisma/schema.prisma"
            },
            "dependencies": {
              "@homeal/db": "file:./packages-db",
              "@homeal/shared": "file:./packages-shared",
              "@azure/storage-blob": "^12.25.0",
              "@prisma/client": "^6.3.0",
              "cors": "^2.8.5",
              "express": "^4.21.0",
              "express-rate-limit": "^7.5.0",
              "firebase-admin": "^13.0.0",
              "helmet": "^8.0.0",
              "ioredis": "^5.4.0",
              "jsonwebtoken": "^9.0.2",
              "multer": "^1.4.5-lts.1",
              "prisma": "^6.3.0",
              "sharp": "^0.33.0",
              "socket.io": "^4.8.0",
              "stripe": "^17.0.0",
              "zod": "^3.24.0"
            },
            "engines": {
              "node": ">=20.0.0"
            }
          }
          EOF

          # 5. Zip (small: just build output + manifests, no node_modules)
          cd deploy && zip -r -q ../deploy.zip . && cd ..

          # 6. Verify artifact
          echo "=== Deploy artifact contents ==="
          ls -la deploy/
          echo ""
          echo "=== Zip size ==="
          ls -lh deploy.zip
          echo ""
          echo "=== Zip file listing (top-level) ==="
          unzip -l deploy.zip | head -30

      - name: Validate deploy artifact
        run: |
          # Fail fast if zip is empty or missing critical files
          if [ ! -f deploy.zip ]; then
            echo "::error::deploy.zip not found!"
            exit 1
          fi
          ZIP_SIZE=$(stat -c%s deploy.zip 2>/dev/null || stat -f%z deploy.zip)
          echo "Zip size: $ZIP_SIZE bytes"
          if [ "$ZIP_SIZE" -lt 1000 ]; then
            echo "::error::deploy.zip is suspiciously small ($ZIP_SIZE bytes)"
            exit 1
          fi
          # Check required files exist in zip
          for f in "dist/server.js" "dist/app.js" "package.json" "server.js"; do
            if ! unzip -l deploy.zip | grep -q "$f"; then
              echo "::error::Missing $f in deploy.zip"
              exit 1
            fi
          done
          echo "Artifact validation passed"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Azure for Oryx build
        run: |
          az webapp config appsettings set --name homeal-api --resource-group rg-visualstudio-lab-mana \
            --settings \
            SCM_DO_BUILD_DURING_DEPLOYMENT=true \
            ENABLE_ORYX_BUILD=true \
            ORYX_NODE_MODULES_COMPRESSION=none
          # Remove any run-from-package setting that bypasses extraction
          az webapp config appsettings delete --name homeal-api --resource-group rg-visualstudio-lab-mana \
            --setting-names WEBSITE_RUN_FROM_PACKAGE 2>/dev/null || true

      - name: Deploy zip to Azure Web App
        run: |
          az webapp deploy --name homeal-api --resource-group rg-visualstudio-lab-mana \
            --src-path deploy.zip --type zip --clean true --async true

      - name: Configure startup and restart
        run: |
          az webapp config set --name homeal-api --resource-group rg-visualstudio-lab-mana \
            --startup-file "node server.js"
          # Give Oryx time to run npm install
          echo "Waiting 60s for Oryx to install dependencies..."
          sleep 60
          az webapp restart --name homeal-api --resource-group rg-visualstudio-lab-mana

      - name: Enable application logging
        run: |
          az webapp log config --name homeal-api --resource-group rg-visualstudio-lab-mana \
            --application-logging filesystem --level verbose --detailed-error-messages true

      - name: Verify deployment
        run: |
          echo "Waiting 120s for app to start with fresh dependencies..."
          sleep 120
          echo "=== Health check ==="
          STATUS=$(curl -s -o /tmp/health.json -w "%{http_code}" https://api.homeal.uk/health)
          echo "HTTP Status: $STATUS"
          cat /tmp/health.json || true
          echo ""
          if [ "$STATUS" = "200" ]; then
            echo "Health check PASSED"
          else
            echo "::warning::Health check returned $STATUS (expected 200)"
            echo "=== Checking Kudu for npm install result ==="
            CREDS=$(az webapp deployment list-publishing-credentials \
              --name homeal-api --resource-group rg-visualstudio-lab-mana \
              --query "{user:publishingUserName, pass:publishingPassword}" -o json)
            KUDU_USER=$(echo "$CREDS" | jq -r '.user')
            KUDU_PASS=$(echo "$CREDS" | jq -r '.pass')
            curl -s -X POST "https://homeal-api.scm.azurewebsites.net/api/command" \
              -u "$KUDU_USER:$KUDU_PASS" \
              -H "Content-Type: application/json" \
              -d '{"command":"ls /home/site/wwwroot/node_modules/express/package.json 2>&1 && echo EXPRESS_FOUND || echo EXPRESS_MISSING","dir":"/home"}' || true
          fi
          echo ""
          echo "=== Login endpoint smoke tests (expect 400/401, not 503) ==="
          for endpoint in "/api/v1/auth/login" "/api/v1/auth/me"; do
            RESP=$(curl -s -o /dev/null -w "%{http_code}" "https://api.homeal.uk${endpoint}")
            echo "$endpoint -> $RESP"
            if [ "$RESP" = "503" ]; then
              echo "::warning::$endpoint still returning 503"
            fi
          done
