generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  CUSTOMER
  CHEF
  ADMIN
  SUPER_ADMIN
}

enum OrderStatus {
  PLACED
  ACCEPTED
  PREPARING
  READY
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  REJECTED
}

enum ServiceType {
  INDIVIDUAL_TIFFIN
  PARTY_ORDERS
  CATERING
  BULK_ORDERS
  MEAL_KITS
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  UPI
  WALLET
  COD
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum NotificationType {
  ORDER_UPDATE
  PROMOTION
  SYSTEM
  CHAT
}

// ==================== MODELS ====================

model User {
  id           String    @id @default(uuid()) @db.VarChar(36)
  name         String    @db.VarChar(255)
  email        String?   @unique @db.VarChar(191)
  phone        String?   @unique @db.VarChar(20)
  passwordHash String?   @db.VarChar(255)
  avatar       String?   @db.VarChar(500)
  role         UserRole  @default(CUSTOMER)
  dietaryPrefs String?   @db.Text
  isActive     Boolean   @default(true)
  firebaseUid  String?   @unique @db.VarChar(128)
  createdAt    DateTime  @default(now()) @db.DateTime(3)
  updatedAt    DateTime  @updatedAt @db.DateTime(3)

  chef          Chef?
  orders        Order[]
  reviews       Review[]
  addresses     Address[]
  notifications Notification[]
  subscriptions Subscription[]
  favorites     Favorite[]
  cart          Cart?

  @@index([email])
  @@index([phone])
  @@index([firebaseUid])
}

model Chef {
  id              String   @id @default(uuid()) @db.VarChar(36)
  userId          String   @unique @db.VarChar(36)
  kitchenName     String   @db.VarChar(255)
  description     String?  @db.Text
  cuisineTypes    String?  @db.Text
  certifications  String?  @db.Text
  bannerImage     String?  @db.VarChar(500)
  latitude        Float?
  longitude       Float?
  deliveryRadius  Float    @default(5.0)
  avgRating       Float    @default(0)
  totalReviews    Int      @default(0)
  isVerified      Boolean  @default(false)
  isOnline        Boolean  @default(false)
  operatingHours  String?  @db.Text
  bankDetails     String?  @db.Text
  commissionRate  Float    @default(15.0)
  stripeAccountId String?  @db.VarChar(191)
  createdAt       DateTime @default(now()) @db.DateTime(3)
  updatedAt       DateTime @updatedAt @db.DateTime(3)

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  menus     Menu[]
  orders    Order[]
  reviews   Review[]
  services  Service[]
  payments  Payment[]

  @@index([latitude, longitude])
  @@index([isOnline])
}

model Menu {
  id        String   @id @default(uuid()) @db.VarChar(36)
  chefId    String   @db.VarChar(36)
  name      String   @db.VarChar(255)
  date      DateTime @db.Date
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.DateTime(3)
  updatedAt DateTime @updatedAt @db.DateTime(3)

  chef  Chef       @relation(fields: [chefId], references: [id], onDelete: Cascade)
  items MenuItem[]

  @@index([chefId, date])
}

model MenuItem {
  id           String   @id @default(uuid()) @db.VarChar(36)
  menuId       String   @db.VarChar(36)
  categoryId   String?  @db.VarChar(36)
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  price        Float
  image        String?  @db.VarChar(500)
  isVeg        Boolean  @default(true)
  isAvailable  Boolean  @default(true)
  calories     Int?
  allergens    String?  @db.Text
  ingredients  String?  @db.Text
  prepTime     Int?
  servingSize  String?  @db.VarChar(100)
  createdAt    DateTime @default(now()) @db.DateTime(3)
  updatedAt    DateTime @updatedAt @db.DateTime(3)

  menu       Menu        @relation(fields: [menuId], references: [id], onDelete: Cascade)
  category   Category?   @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  cartItems  CartItem[]
  favorites  Favorite[]

  @@index([menuId])
  @@index([categoryId])
}

model Category {
  id        String   @id @default(uuid()) @db.VarChar(36)
  name      String   @unique @db.VarChar(191)
  icon      String?  @db.VarChar(50)
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.DateTime(3)

  items MenuItem[]
}

model Order {
  id              String      @id @default(uuid()) @db.VarChar(36)
  userId          String      @db.VarChar(36)
  chefId          String      @db.VarChar(36)
  addressId       String      @db.VarChar(36)
  status          OrderStatus @default(PLACED)
  subtotal        Float
  deliveryFee     Float       @default(0)
  discount        Float       @default(0)
  total           Float
  specialInstructions String? @db.Text
  estimatedDelivery   DateTime? @db.DateTime(3)
  actualDelivery      DateTime? @db.DateTime(3)
  promoCodeId     String?     @db.VarChar(36)
  createdAt       DateTime    @default(now()) @db.DateTime(3)
  updatedAt       DateTime    @updatedAt @db.DateTime(3)

  user      User        @relation(fields: [userId], references: [id])
  chef      Chef        @relation(fields: [chefId], references: [id])
  address   Address     @relation(fields: [addressId], references: [id])
  promoCode PromoCode?  @relation(fields: [promoCodeId], references: [id])
  items     OrderItem[]
  payment   Payment?
  review    Review?

  @@index([userId])
  @@index([chefId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id         String @id @default(uuid()) @db.VarChar(36)
  orderId    String @db.VarChar(36)
  menuItemId String @db.VarChar(36)
  quantity   Int
  price      Float
  notes      String? @db.Text

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
}

model Service {
  id          String      @id @default(uuid()) @db.VarChar(36)
  chefId      String      @db.VarChar(36)
  type        ServiceType
  name        String      @db.VarChar(255)
  description String?     @db.Text
  basePrice   Float
  minOrder    Int         @default(1)
  maxOrder    Int?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now()) @db.DateTime(3)
  updatedAt   DateTime    @updatedAt @db.DateTime(3)

  chef Chef @relation(fields: [chefId], references: [id], onDelete: Cascade)

  @@index([chefId])
  @@index([type])
}

model Subscription {
  id        String             @id @default(uuid()) @db.VarChar(36)
  userId    String             @db.VarChar(36)
  name      String             @db.VarChar(255)
  plan      String             @db.VarChar(100)
  price     Float
  startDate DateTime           @db.Date
  endDate   DateTime           @db.Date
  status    SubscriptionStatus @default(ACTIVE)
  meals     String?            @db.Text
  createdAt DateTime           @default(now()) @db.DateTime(3)
  updatedAt DateTime           @updatedAt @db.DateTime(3)

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model Review {
  id        String   @id @default(uuid()) @db.VarChar(36)
  userId    String   @db.VarChar(36)
  chefId    String   @db.VarChar(36)
  orderId   String   @unique @db.VarChar(36)
  rating    Int
  comment   String?  @db.Text
  images    String?  @db.Text
  reply     String?  @db.Text
  createdAt DateTime @default(now()) @db.DateTime(3)
  updatedAt DateTime @updatedAt @db.DateTime(3)

  user  User  @relation(fields: [userId], references: [id])
  chef  Chef  @relation(fields: [chefId], references: [id])
  order Order @relation(fields: [orderId], references: [id])

  @@index([chefId])
  @@index([rating])
}

model Notification {
  id        String           @id @default(uuid()) @db.VarChar(36)
  userId    String           @db.VarChar(36)
  type      NotificationType @default(SYSTEM)
  title     String           @db.VarChar(255)
  body      String           @db.Text
  data      String?          @db.Text
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now()) @db.DateTime(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

model Payment {
  id              String        @id @default(uuid()) @db.VarChar(36)
  orderId         String        @unique @db.VarChar(36)
  chefId          String        @db.VarChar(36)
  amount          Float
  platformFee     Float         @default(0)
  chefPayout      Float         @default(0)
  method          PaymentMethod @default(CARD)
  status          PaymentStatus @default(PENDING)
  stripePaymentId String?       @db.VarChar(191)
  createdAt       DateTime      @default(now()) @db.DateTime(3)
  updatedAt       DateTime      @updatedAt @db.DateTime(3)

  order Order @relation(fields: [orderId], references: [id])
  chef  Chef  @relation(fields: [chefId], references: [id])

  @@index([chefId])
  @@index([status])
}

model Address {
  id        String   @id @default(uuid()) @db.VarChar(36)
  userId    String   @db.VarChar(36)
  label     String   @db.VarChar(50)
  line1     String   @db.VarChar(255)
  line2     String?  @db.VarChar(255)
  city      String   @db.VarChar(100)
  state     String   @db.VarChar(100)
  zipCode   String   @db.VarChar(10)
  latitude  Float?
  longitude Float?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now()) @db.DateTime(3)

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
}

model Cart {
  id        String   @id @default(uuid()) @db.VarChar(36)
  userId    String   @unique @db.VarChar(36)
  createdAt DateTime @default(now()) @db.DateTime(3)
  updatedAt DateTime @updatedAt @db.DateTime(3)

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]
}

model CartItem {
  id         String @id @default(uuid()) @db.VarChar(36)
  cartId     String @db.VarChar(36)
  menuItemId String @db.VarChar(36)
  quantity   Int    @default(1)

  cart     Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@unique([cartId, menuItemId])
}

model Favorite {
  id         String   @id @default(uuid()) @db.VarChar(36)
  userId     String   @db.VarChar(36)
  menuItemId String   @db.VarChar(36)
  createdAt  DateTime @default(now()) @db.DateTime(3)

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([userId, menuItemId])
}

model PromoCode {
  id            String    @id @default(uuid()) @db.VarChar(36)
  code          String    @unique @db.VarChar(191)
  description   String?   @db.Text
  discountType  String    @db.VarChar(20)
  discountValue Float
  minOrderValue Float     @default(0)
  maxDiscount   Float?
  usageLimit    Int?
  usedCount     Int       @default(0)
  validFrom     DateTime  @db.DateTime(3)
  validUntil    DateTime  @db.DateTime(3)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now()) @db.DateTime(3)

  orders Order[]

  @@index([code])
}
